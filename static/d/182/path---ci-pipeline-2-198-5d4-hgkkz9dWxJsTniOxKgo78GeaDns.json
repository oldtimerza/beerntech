{"data":{"site":{"siteMetadata":{"title":"Beer n Tech"}},"markdownRemark":{"id":"c7936668-7af4-568f-ab21-362616656a83","excerpt":"Welcome back In part 1 of this tutorial we went through setting up a Digital ocean droplet, Docker hub , github repo and a Circle CI account to connect and get…","html":"<h2>Welcome back</h2>\n<p>In part 1 of this tutorial we went through setting up a Digital ocean droplet, Docker hub , github repo and a Circle CI account to connect and get our latest code changes from repo and access our digital ocean droplet.</p>\n<p>In this tutorial we will continue from that starting point and configure our Circle ci <strong>workflow</strong> to pull our latest changes, build our project , test it and deploy it via a docker image to our Digital Ocean droplet.</p>\n<p>Let’s get started!</p>\n<h2>Circle CI config</h2>\n<p>We created a .circleci/config.yml file in our setup step. This time around we will edit this file to create a <strong>workflow</strong> that will do everything we need automatically everytime we push a code change to our repo.</p>\n<p>What is a workflow? A <strong>workflow</strong> is the step-by-step process that Cicle CI follows to do the things we want.\nThe workflows is setup in our config.yml file and uses a series of <strong>jobs</strong> defined in our config.yml file to achieve our deployment process.</p>\n<blockquote>\n<p>workflows orders our jobs and jobs are a named collection of steps.</p>\n</blockquote>\n<p>Our <strong>config.yml</strong> will look like the following when we are done:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> circleci/node<span class=\"token punctuation\">:</span><span class=\"token number\">8</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">NODE_ENV</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'test'</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> checkout\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">restore_cache</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> dependency<span class=\"token punctuation\">-</span>cache<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"package.json\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install Dependencies\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> yarn install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>production=false\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">save_cache</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> dependency<span class=\"token punctuation\">-</span>cache<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"package.json\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> ./node_modules\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Test\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> yarn test\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> circleci/node<span class=\"token punctuation\">:</span><span class=\"token number\">7</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> checkout\n      <span class=\"token punctuation\">-</span> setup_remote_docker\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy image to Docker Hub\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            docker build --build-arg DOCKER_USER=$DOCKER_USER --build-arg DOCKER_PASSWORD=$DOCKER_PASSWORD -t oldtimerza/blade-express .\n            docker login -u $DOCKER_USER -p $DOCKER_PASSWORD\n            docker push oldtimerza/blade-express</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Run docker image on Digital Ocean Droplet\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            ssh $SSH_USER@$SSH_HOST -o StrictHostKeyChecking=no 'docker stop app &amp;&amp; docker rm $(docker ps -a -q) &amp;&amp; docker rmi $(docker images -q) &amp;&amp; docker pull oldtimerza/blade-express &amp;&amp; docker run -d -t -p 80:3000 --name app oldtimerza/blade-express'</span>\n\n<span class=\"token key atrule\">workflows</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">build-deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> build\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requires</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> build\n          <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">only</span><span class=\"token punctuation\">:</span> master</code></pre></div>","frontmatter":{"title":"Simple CI pipeline - Part 2 - Configuration","date":"January 22, 2019","author":{"id":"Bradley Morris","bio":"Software engineer interested in modern web tech","avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAUDBP/EABUBAQEAAAAAAAAAAAAAAAAAAAIB/9oADAMBAAIQAxAAAAHl6cqpUxoJl2hWUGP/xAAcEAACAgMBAQAAAAAAAAAAAAABAgADBBESISL/2gAIAQEAAQUCx6hYrU8TmYvg+dNYoPRSykloSd//xAAWEQADAAAAAAAAAAAAAAAAAAAAEBH/2gAIAQMBAT8BdP/EABYRAAMAAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPwFw/8QAGxAAAQQDAAAAAAAAAAAAAAAAAAECITEQQYH/2gAIAQEABj8CsjFnSVIHOXQp/8QAGxAAAwADAQEAAAAAAAAAAAAAAAERITFBUXH/2gAIAQEAAT8hqGyXgta9XRmFN9aFGK+CXgyBrwuGtcISl6f/2gAMAwEAAgADAAAAEOPgwv/EABgRAQEAAwAAAAAAAAAAAAAAAAARASFR/9oACAEDAQE/EJpGFdf/xAAYEQADAQEAAAAAAAAAAAAAAAAAARExUf/aAAgBAgEBPxB6VjI4f//EABsQAQEBAQEAAwAAAAAAAAAAAAERACExQWGB/9oACAEBAAE/EAplxARfvASM5F8184ha4jzz80OUBY7fc9AnZLMIGU0fE3iwDeHHuqaVrv/Z","width":50,"height":50,"src":"/static/41ebf602913bbad75cc6f4357872ad71/d2d31/bradley-morris.jpg","srcSet":"/static/41ebf602913bbad75cc6f4357872ad71/d2d31/bradley-morris.jpg 1x,\n/static/41ebf602913bbad75cc6f4357872ad71/0b804/bradley-morris.jpg 1.5x,\n/static/41ebf602913bbad75cc6f4357872ad71/753c3/bradley-morris.jpg 2x,\n/static/41ebf602913bbad75cc6f4357872ad71/31ca8/bradley-morris.jpg 3x"}}}}}}},"pageContext":{"slug":"/ci-pipeline-2/","previous":{"fields":{"slug":"/ci-pipeline-1/"},"frontmatter":{"title":"Simple CI pipeline - Part 1 - Setup"}},"next":null}}